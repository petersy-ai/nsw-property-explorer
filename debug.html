<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSW Property Data - Debug Version</title>
    <link rel="stylesheet" href="leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        .debug-panel {
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            border-bottom: 2px solid #333;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .stats {
            background: white;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        #map {
            height: 400px;
            margin: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            margin: 10px;
            border-radius: 5px;
            border-left: 4px solid #c62828;
        }
    </style>
</head>
<body>
    <div class="debug-panel" id="debug-log">
        <div>ğŸ” DEBUG MODE - Leaflet Loading Analysis</div>
    </div>
    
    <div class="header">
        <h1>NSW Property Data - Debug Version</h1>
        <p>Diagnosing Leaflet.js loading issues</p>
    </div>
    
    <div class="stats" id="stats">
        <div>Initializing diagnostics...</div>
    </div>
    
    <div id="map"></div>

    <script>
        // Debug logging system
        const debugLog = document.getElementById('debug-log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substr(11, 12);
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#fff';
            const logEntry = document.createElement('div');
            logEntry.style.color = color;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // Phase 1: Environment Analysis
        log('ğŸš€ Starting Leaflet diagnostic sequence');
        log(`ğŸ“Š User Agent: ${navigator.userAgent}`);
        log(`ğŸŒ Location: ${window.location.href}`);
        log(`ğŸ“„ Document Ready State: ${document.readyState}`);

        // Phase 2: Script Loading Analysis
        log('ğŸ“¦ Analyzing script loading...');
        
        // Check if Leaflet is already available
        if (typeof L !== 'undefined') {
            log('âœ… Leaflet global variable exists', 'success');
            log(`ğŸ“‹ Leaflet version: ${L.version || 'unknown'}`);
            log(`ğŸ”§ L.map function: ${typeof L.map}`);
        } else {
            log('âŒ Leaflet global variable not found', 'error');
        }

        // Phase 3: File Integrity Check
        log('ğŸ” Checking file integrity...');
        
        fetch('leaflet.js')
            .then(response => {
                log(`ğŸ“ Leaflet.js response status: ${response.status}`);
                log(`ğŸ“ Content length: ${response.headers.get('content-length') || 'unknown'}`);
                log(`ğŸ“‹ Content type: ${response.headers.get('content-type') || 'unknown'}`);
                return response.text();
            })
            .then(content => {
                log(`ğŸ“Š File size: ${content.length} characters`);
                log(`ğŸ” Contains 'L.map': ${content.includes('L.map')}`);
                log(`ğŸ” Contains 'L.version': ${content.includes('L.version')}`);
                log(`ğŸ” File starts with: "${content.substring(0, 50)}..."`);
                log(`ğŸ” File ends with: "...${content.substring(content.length - 50)}"`);
            })
            .catch(error => {
                log(`âŒ Failed to fetch leaflet.js: ${error.message}`, 'error');
            });

        // Phase 4: CSS Loading Check
        fetch('leaflet.css')
            .then(response => {
                log(`ğŸ¨ Leaflet.css response status: ${response.status}`);
                return response.text();
            })
            .then(content => {
                log(`ğŸ¨ CSS file size: ${content.length} characters`);
                log(`ğŸ” Contains '.leaflet-': ${content.includes('.leaflet-')}`);
            })
            .catch(error => {
                log(`âŒ Failed to fetch leaflet.css: ${error.message}`, 'error');
            });

        // Phase 5: Script Load Event Monitoring
        const leafletScript = document.createElement('script');
        leafletScript.src = 'leaflet.js';
        
        leafletScript.onload = function() {
            log('âœ… Leaflet script onload event fired', 'success');
            
            // Immediate check
            if (typeof L !== 'undefined') {
                log('âœ… Leaflet available immediately after load', 'success');
                log(`ğŸ“‹ Leaflet version: ${L.version || 'unknown'}`);
                log(`ğŸ”§ L.map type: ${typeof L.map}`);
                
                if (typeof L.map === 'function') {
                    log('âœ… L.map is a function - ready to use!', 'success');
                    initializeApp();
                } else {
                    log('âŒ L.map is not a function', 'error');
                    log(`ğŸ” L object keys: ${Object.keys(L).slice(0, 10).join(', ')}`);
                }
            } else {
                log('âŒ Leaflet still not available after load event', 'error');
            }
        };
        
        leafletScript.onerror = function(error) {
            log(`âŒ Leaflet script onerror event: ${error}`, 'error');
        };
        
        log('ğŸ“¦ Adding Leaflet script to document...');
        document.head.appendChild(leafletScript);

        // Phase 6: Polling Check
        let pollCount = 0;
        const maxPolls = 50;
        
        function pollForLeaflet() {
            pollCount++;
            log(`ğŸ”„ Poll ${pollCount}/${maxPolls}: Checking Leaflet availability...`);
            
            if (typeof L !== 'undefined' && typeof L.map === 'function') {
                log('âœ… Leaflet ready via polling!', 'success');
                initializeApp();
                return;
            }
            
            if (pollCount < maxPolls) {
                setTimeout(pollForLeaflet, 100);
            } else {
                log('âŒ Polling timeout - Leaflet never became available', 'error');
                showFinalDiagnostic();
            }
        }
        
        // Start polling after a short delay
        setTimeout(pollForLeaflet, 500);

        // Application initialization
        function initializeApp() {
            log('ğŸ¯ Starting application initialization...', 'success');
            
            try {
                // Test basic Leaflet functionality
                log('ğŸ—ºï¸ Testing L.map creation...');
                const testMap = L.map('map').setView([51.505, -0.09], 13);
                log('âœ… Map created successfully!', 'success');
                
                // Test tile layer
                log('ğŸŒ Adding tile layer...');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(testMap);
                log('âœ… Tile layer added successfully!', 'success');
                
                // Update stats
                document.getElementById('stats').innerHTML = `
                    <span style="color: green;">âœ… Leaflet loaded successfully!</span><br>
                    <span>Version: ${L.version || 'unknown'}</span><br>
                    <span>Map initialized and ready</span>
                `;
                
            } catch (error) {
                log(`âŒ Application initialization failed: ${error.message}`, 'error');
                log(`ğŸ” Error stack: ${error.stack}`, 'error');
            }
        }

        // Final diagnostic if everything fails
        function showFinalDiagnostic() {
            log('ğŸ“‹ FINAL DIAGNOSTIC SUMMARY:', 'error');
            log(`ğŸŒ Window.L exists: ${typeof window.L !== 'undefined'}`, 'error');
            log(`ğŸ”§ Global L exists: ${typeof L !== 'undefined'}`, 'error');
            
            if (typeof L !== 'undefined') {
                log(`ğŸ“‹ L object type: ${typeof L}`, 'error');
                log(`ğŸ” L object keys: ${Object.keys(L).join(', ')}`, 'error');
                log(`ğŸ”§ L.map exists: ${typeof L.map !== 'undefined'}`, 'error');
                log(`ğŸ”§ L.map type: ${typeof L.map}`, 'error');
            }
            
            // Check for any script errors
            log('ğŸ” Checking for script elements...');
            const scripts = document.querySelectorAll('script[src*="leaflet"]');
            log(`ğŸ“¦ Found ${scripts.length} Leaflet script elements`);
            
            document.getElementById('stats').innerHTML = `
                <div class="error">
                    âŒ Leaflet failed to load properly<br>
                    Check the debug log above for details
                </div>
            `;
        }

        // Global error handler
        window.addEventListener('error', function(event) {
            log(`âŒ Global error: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
        });

        // Document ready check
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                log('ğŸ“„ DOMContentLoaded event fired');
            });
        } else {
            log('ğŸ“„ Document already ready');
        }

        log('ğŸ” Diagnostic setup complete - monitoring Leaflet loading...');
    </script>
</body>
</html>

